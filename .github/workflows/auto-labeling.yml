name: Auto Labeling with Claude

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚ã‚µãƒãƒ¼ãƒˆ
    inputs:
      dry_run:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®æ›´æ–°ã‚’è¡Œã‚ãªã„ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      max_articles:
        description: 'å‡¦ç†ã™ã‚‹æœ€å¤§è¨˜äº‹æ•°ï¼ˆç©ºã®å ´åˆã¯å…¨ã¦ï¼‰'
        required: false
        default: ''
        type: string

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and Build MCP
        id: build-mcp
        run: |
          cd mcp
          pnpm install
          pnpm run build
          echo "MCPãƒ“ãƒ«ãƒ‰å®Œäº†"
          echo "build_status=success" >> $GITHUB_OUTPUT
          # MCPãƒ“ãƒ«ãƒ‰ã®ç¢ºèª
          if [ -f "build/index.js" ]; then
            echo "âœ… MCPãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
            ls -la build/
          else
            echo "::error::MCPãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
        continue-on-error: true

      - name: Validate MCP Build
        if: steps.build-mcp.outputs.build_status != 'success'
        run: |
          echo "::error::MCPã®ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1

      - name: Test API Connection
        id: test-api
        run: |
          echo "APIã®æ¥ç¶šãƒ†ã‚¹ãƒˆ..."
          API_URL="https://effective-yomimono-api.ryosuke-horie37.workers.dev"
          
          # APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          if curl -f -s -o /dev/null -w "%{http_code}" "${API_URL}/api/health" | grep -q "200\|404"; then
            echo "âœ… APIã¸ã®æ¥ç¶šãŒç¢ºèªã§ãã¾ã—ãŸ"
            echo "api_status=success" >> $GITHUB_OUTPUT
          else
            echo "::warning::APIã¸ã®æ¥ç¶šã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
            echo "api_status=warning" >> $GITHUB_OUTPUT
          fi
          
          # ãƒ©ãƒ™ãƒ«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
          LABELS_RESPONSE=$(curl -s -w "\n%{http_code}" "${API_URL}/api/labels" | tail -n 1)
          if [[ "$LABELS_RESPONSE" == "200" ]]; then
            echo "âœ… ãƒ©ãƒ™ãƒ«APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒæ­£å¸¸ã«å¿œç­”ã—ã¦ã„ã¾ã™"
          else
            echo "::warning::ãƒ©ãƒ™ãƒ«APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å¿œç­”: HTTP $LABELS_RESPONSE"
          fi
        continue-on-error: true

      - name: Test MCP Server
        id: test-mcp
        run: |
          echo "MCPã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ãƒ†ã‚¹ãƒˆ..."
          cd mcp
          
          # MCPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦åˆæœŸåŒ–ã‚’å¾…ã¤
          timeout 10s node build/index.js 2>&1 | head -20 || true
          
          # ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [ -f "build/index.js" ]; then
            echo "âœ… MCPãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"
            echo "mcp_status=success" >> $GITHUB_OUTPUT
          else
            echo "::error::MCPãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "mcp_status=failure" >> $GITHUB_OUTPUT
          fi
          
          echo "MCPã‚µãƒ¼ãƒãƒ¼ã®ãƒ†ã‚¹ãƒˆå®Œäº†"
        continue-on-error: true

      - name: Pre-flight Check
        id: preflight
        run: |
          echo "äº‹å‰ãƒã‚§ãƒƒã‚¯é–‹å§‹..."
          
          # å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
          if [[ -z "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" ]]; then
            echo "::error::CLAUDE_CODE_OAUTH_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          
          # MCPã¨APIã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          if [[ "${{ steps.test-mcp.outputs.mcp_status }}" == "failure" ]]; then
            echo "::warning::MCPã‚µãƒ¼ãƒãƒ¼ã®ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¦ã„ã¾ã™"
          fi
          
          if [[ "${{ steps.test-api.outputs.api_status }}" == "warning" ]]; then
            echo "::warning::APIæ¥ç¶šã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
          fi
          
          echo "âœ… äº‹å‰ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: Run Claude Auto Labeling (Attempt 1)
        id: claude-labeling-1
        uses: anthropics/claude-code-action@beta
        continue-on-error: true
        timeout-minutes: 5
        env:
          ACTIONS_RUNNER_DEBUG: true
          ACTIONS_STEP_DEBUG: true
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # MCPã‚µãƒ¼ãƒãƒ¼è¨­å®š
          mcp_servers: |
            {
              "effective-yomimono-mcp": {
                "command": "node",
                "args": ["${{ github.workspace }}/mcp/build/index.js"],
                "env": {
                  "API_BASE_URL": "https://effective-yomimono-api.ryosuke-horie37.workers.dev"
                }
              }
            }
          
          # Direct prompt for automated labeling
          direct_prompt: |
            MCPãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦è¨˜äº‹ã®è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            
            ç’°å¢ƒè¨­å®šï¼š
            - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.dry_run || 'false' }}
            - æœ€å¤§å‡¦ç†è¨˜äº‹æ•°: ${{ github.event.inputs.max_articles || 'åˆ¶é™ãªã—' }}
            
            ä»¥ä¸‹ã®æ‰‹é †ã§å‡¦ç†ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
            
            1. ã¾ãšã€getLabels ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ä¸€è¦§ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
            2. æ¬¡ã«ã€getUnlabeledArticles ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒ©ãƒ™ãƒ«ä»˜ã‘ã•ã‚Œã¦ã„ãªã„è¨˜äº‹ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
            3. ${{ github.event.inputs.max_articles && format('æœ€å¤§{0}ä»¶ã®è¨˜äº‹ã‚’å‡¦ç†ã—ã¦ãã ã•ã„ã€‚', github.event.inputs.max_articles) || 'å…¨ã¦ã®æœªãƒ©ãƒ™ãƒ«è¨˜äº‹ã‚’å‡¦ç†ã—ã¦ãã ã•ã„ã€‚' }}
            4. å„è¨˜äº‹ã«å¯¾ã—ã¦ã€ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‹ã‚‰æœ€ã‚‚é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚
               - æŠ€è¡“ç³»è¨˜äº‹ã®å ´åˆ: ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€ãƒ„ãƒ¼ãƒ«åãªã©ã‹ã‚‰åˆ¤å®š
               - æ¦‚å¿µçš„ãªè¨˜äº‹ã®å ´åˆ: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ãªã©ã‹ã‚‰åˆ¤å®š
            5. ${{ github.event.inputs.dry_run == 'true' && 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€å®Ÿéš›ã®ãƒ©ãƒ™ãƒ«ä»˜ã‘ã¯è¡Œã‚ãšã€åˆ¤å®šçµæœã®ã¿å ±å‘Šã—ã¦ãã ã•ã„ã€‚' || 'assignLabel ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€åˆ¤å®šã—ãŸãƒ©ãƒ™ãƒ«ã‚’è¨˜äº‹ã«å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„ã€‚' }}
            6. è¤‡æ•°ã®è¨˜äº‹ã«åŒã˜ãƒ©ãƒ™ãƒ«ã‚’ä»˜ã‘ã‚‹å ´åˆã¯ã€assignLabelsToMultipleArticles ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦åŠ¹ç‡åŒ–ã—ã¦ãã ã•ã„ã€‚
            
            å‡¦ç†çµæœã¨ã—ã¦ä»¥ä¸‹ã‚’å¿…ãšå ±å‘Šã—ã¦ãã ã•ã„ï¼š
            - å‡¦ç†å¯¾è±¡è¨˜äº‹ã®ç·æ•°
            - å‡¦ç†å®Œäº†è¨˜äº‹æ•°
            - ä»˜ä¸ã—ãŸãƒ©ãƒ™ãƒ«ã®å†…è¨³ï¼ˆãƒ©ãƒ™ãƒ«å: è¨˜äº‹æ•°ï¼‰
            - æ–°è¦ä½œæˆã—ãŸãƒ©ãƒ™ãƒ«ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
            - ãƒ©ãƒ™ãƒ«ä»˜ã‘ã§ããªã‹ã£ãŸè¨˜äº‹ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰ã¨ãã®ç†ç”±
            - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãã®è©³ç´°
            
            å‡ºåŠ›å½¢å¼ï¼š
            ```summary
            å‡¦ç†çµæœã‚µãƒãƒªãƒ¼:
            - å‡¦ç†å¯¾è±¡: Xä»¶
            - å‡¦ç†å®Œäº†: Yä»¶
            - å‡¦ç†å¤±æ•—: Zä»¶
            ```
            
            æ³¨æ„äº‹é …ï¼š
            - æ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ã‚’ã§ãã‚‹ã ã‘æ´»ç”¨ã—ã¦ãã ã•ã„
            - æ–°ã—ã„ãƒ©ãƒ™ãƒ«ã¯æœ¬å½“ã«å¿…è¦ãªå ´åˆã®ã¿ä½œæˆã—ã¦ãã ã•ã„
            - ãƒ©ãƒ™ãƒ«åã¯ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ã„ã‚‚ã®ã«ã—ã¦ãã ã•ã„
            - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯è©³ç´°ã‚’å ±å‘Šã—ã¦ãã ã•ã„

      - name: Wait Before Retry
        if: steps.claude-labeling-1.outcome == 'failure'
        run: |
          echo "::warning::1å›ç›®ã®è©¦è¡ŒãŒå¤±æ•—ã—ã¾ã—ãŸã€‚10ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™..."
          sleep 10

      - name: Run Claude Auto Labeling (Retry - Attempt 2)
        if: steps.claude-labeling-1.outcome == 'failure'
        id: claude-labeling-2
        uses: anthropics/claude-code-action@beta
        continue-on-error: true
        timeout-minutes: 5
        env:
          ACTIONS_RUNNER_DEBUG: true
          ACTIONS_STEP_DEBUG: true
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # MCPã‚µãƒ¼ãƒãƒ¼è¨­å®š
          mcp_servers: |
            {
              "effective-yomimono-mcp": {
                "command": "node",
                "args": ["${{ github.workspace }}/mcp/build/index.js"],
                "env": {
                  "API_BASE_URL": "https://effective-yomimono-api.ryosuke-horie37.workers.dev"
                }
              }
            }
          
          # Direct prompt for automated labeling (retry)
          direct_prompt: |
            ã€ãƒªãƒˆãƒ©ã‚¤å®Ÿè¡Œã€‘MCPãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦è¨˜äº‹ã®è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            
            ç’°å¢ƒè¨­å®šï¼š
            - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.dry_run || 'false' }}
            - æœ€å¤§å‡¦ç†è¨˜äº‹æ•°: ${{ github.event.inputs.max_articles || 'åˆ¶é™ãªã—' }}
            - ãƒªãƒˆãƒ©ã‚¤å›æ•°: 2å›ç›®
            
            ä»¥ä¸‹ã®æ‰‹é †ã§å‡¦ç†ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
            
            1. ã¾ãšã€getLabels ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ä¸€è¦§ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
            2. æ¬¡ã«ã€getUnlabeledArticles ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒ©ãƒ™ãƒ«ä»˜ã‘ã•ã‚Œã¦ã„ãªã„è¨˜äº‹ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚
            3. ${{ github.event.inputs.max_articles && format('æœ€å¤§{0}ä»¶ã®è¨˜äº‹ã‚’å‡¦ç†ã—ã¦ãã ã•ã„ã€‚', github.event.inputs.max_articles) || 'å…¨ã¦ã®æœªãƒ©ãƒ™ãƒ«è¨˜äº‹ã‚’å‡¦ç†ã—ã¦ãã ã•ã„ã€‚' }}
            4. å„è¨˜äº‹ã«å¯¾ã—ã¦ã€ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‹ã‚‰æœ€ã‚‚é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚
            5. ${{ github.event.inputs.dry_run == 'true' && 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€å®Ÿéš›ã®ãƒ©ãƒ™ãƒ«ä»˜ã‘ã¯è¡Œã‚ãšã€åˆ¤å®šçµæœã®ã¿å ±å‘Šã—ã¦ãã ã•ã„ã€‚' || 'assignLabel ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€åˆ¤å®šã—ãŸãƒ©ãƒ™ãƒ«ã‚’è¨˜äº‹ã«å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„ã€‚' }}
            
            å‡¦ç†çµæœã¨ã—ã¦ä»¥ä¸‹ã‚’å¿…ãšå ±å‘Šã—ã¦ãã ã•ã„ï¼š
            - å‡¦ç†å¯¾è±¡è¨˜äº‹ã®ç·æ•°
            - å‡¦ç†å®Œäº†è¨˜äº‹æ•°
            - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãã®è©³ç´°
            
            ```summary
            å‡¦ç†çµæœã‚µãƒãƒªãƒ¼:
            - å‡¦ç†å¯¾è±¡: Xä»¶
            - å‡¦ç†å®Œäº†: Yä»¶
            - å‡¦ç†å¤±æ•—: Zä»¶
            ```

      - name: Wait Before Final Retry
        if: steps.claude-labeling-1.outcome == 'failure' && steps.claude-labeling-2.outcome == 'failure'
        run: |
          echo "::warning::2å›ç›®ã®è©¦è¡Œã‚‚å¤±æ•—ã—ã¾ã—ãŸã€‚20ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰æœ€çµ‚ãƒªãƒˆãƒ©ã‚¤ã—ã¾ã™..."
          sleep 20

      - name: Run Claude Auto Labeling (Final Retry - Attempt 3)
        if: steps.claude-labeling-1.outcome == 'failure' && steps.claude-labeling-2.outcome == 'failure'
        id: claude-labeling-3
        uses: anthropics/claude-code-action@beta
        continue-on-error: true
        timeout-minutes: 5
        env:
          ACTIONS_RUNNER_DEBUG: true
          ACTIONS_STEP_DEBUG: true
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # MCPã‚µãƒ¼ãƒãƒ¼è¨­å®š
          mcp_servers: |
            {
              "effective-yomimono-mcp": {
                "command": "node",
                "args": ["${{ github.workspace }}/mcp/build/index.js"],
                "env": {
                  "API_BASE_URL": "https://effective-yomimono-api.ryosuke-horie37.workers.dev"
                }
              }
            }
          
          # Direct prompt for automated labeling (final retry)
          direct_prompt: |
            ã€æœ€çµ‚ãƒªãƒˆãƒ©ã‚¤å®Ÿè¡Œã€‘MCPãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦è¨˜äº‹ã®è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
            
            ç’°å¢ƒè¨­å®šï¼š
            - ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ${{ github.event.inputs.dry_run || 'false' }}
            - æœ€å¤§å‡¦ç†è¨˜äº‹æ•°: ${{ github.event.inputs.max_articles || '10' }}ï¼ˆæœ€çµ‚ãƒªãƒˆãƒ©ã‚¤ã®ãŸã‚åˆ¶é™ï¼‰
            - ãƒªãƒˆãƒ©ã‚¤å›æ•°: 3å›ç›®ï¼ˆæœ€çµ‚ï¼‰
            
            æœ€å°é™ã®å‡¦ç†ã§ã‚‚è‰¯ã„ã®ã§ã€ç¢ºå®Ÿã«å‹•ä½œã•ã›ã¦ãã ã•ã„ï¼š
            
            1. getLabels ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦æ—¢å­˜ã®ãƒ©ãƒ™ãƒ«ä¸€è¦§ã‚’å–å¾—
            2. getUnlabeledArticles ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦æœªãƒ©ãƒ™ãƒ«è¨˜äº‹ã‚’å–å¾—
            3. æœ€å¤§10ä»¶ã®è¨˜äº‹ã®ã¿å‡¦ç†
            4. ${{ github.event.inputs.dry_run == 'true' && 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã€åˆ¤å®šçµæœã®ã¿å ±å‘Š' || 'assignLabel ã§è¨˜äº‹ã«ãƒ©ãƒ™ãƒ«ä»˜ã‘' }}
            
            ç°¡æ½”ãªçµæœå ±å‘Šï¼š
            - å‡¦ç†ä»¶æ•°: Xä»¶
            - æˆåŠŸ/å¤±æ•—

      - name: Determine Final Status
        id: final-status
        run: |
          if [[ "${{ steps.claude-labeling-1.outcome }}" == "success" ]]; then
            echo "final_outcome=success" >> $GITHUB_OUTPUT
            echo "attempt_count=1" >> $GITHUB_OUTPUT
            echo "::notice::è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼ˆ1å›ç›®ã®è©¦è¡Œã§æˆåŠŸï¼‰"
          elif [[ "${{ steps.claude-labeling-2.outcome }}" == "success" ]]; then
            echo "final_outcome=success" >> $GITHUB_OUTPUT
            echo "attempt_count=2" >> $GITHUB_OUTPUT
            echo "::warning::è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆ2å›ç›®ã®è©¦è¡Œã§æˆåŠŸï¼‰"
          elif [[ "${{ steps.claude-labeling-3.outcome }}" == "success" ]]; then
            echo "final_outcome=success" >> $GITHUB_OUTPUT
            echo "attempt_count=3" >> $GITHUB_OUTPUT
            echo "::warning::è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆ3å›ç›®ã®è©¦è¡Œã§æˆåŠŸï¼‰"
          else
            echo "final_outcome=failure" >> $GITHUB_OUTPUT
            echo "attempt_count=3" >> $GITHUB_OUTPUT
            echo "::error::è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘ãŒå¤±æ•—ã—ã¾ã—ãŸï¼ˆ3å›ã®è©¦è¡Œå…¨ã¦å¤±æ•—ï¼‰"
          fi

      - name: Generate Job Summary
        if: always()
        run: |
          echo "# ğŸ“‹ è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.final-status.outputs.final_outcome }}" == "success" ]]; then
            echo "âœ… **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”„ **è©¦è¡Œå›æ•°**: ${{ steps.final-status.outputs.attempt_count }}å›" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”„ **è©¦è¡Œå›æ•°**: 3å›ï¼ˆå…¨ã¦å¤±æ•—ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## å®Ÿè¡Œè¨­å®š" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰**: ${{ github.event_name == 'schedule' && 'å®šæœŸå®Ÿè¡Œ' || 'æ‰‹å‹•å®Ÿè¡Œ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰**: ${{ github.event.inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æœ€å¤§å‡¦ç†è¨˜äº‹æ•°**: ${{ github.event.inputs.max_articles || 'åˆ¶é™ãªã—' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S JST' -d '+9 hours')" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## å„è©¦è¡Œã®çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "| è©¦è¡Œ | çµæœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1å›ç›® | ${{ steps.claude-labeling-1.outcome == 'success' && 'âœ… æˆåŠŸ' || steps.claude-labeling-1.outcome == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2å›ç›® | ${{ steps.claude-labeling-2.outcome == 'success' && 'âœ… æˆåŠŸ' || steps.claude-labeling-2.outcome == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3å›ç›® | ${{ steps.claude-labeling-3.outcome == 'success' && 'âœ… æˆåŠŸ' || steps.claude-labeling-3.outcome == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' || 'âŒ å¤±æ•—' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Create Issue on Failure
        if: steps.final-status.outputs.final_outcome == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•— - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## ã‚¨ãƒ©ãƒ¼æ¦‚è¦
            
            è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒ3å›ã®è©¦è¡Œã™ã¹ã¦ã§å¤±æ•—ã—ã¾ã—ãŸã€‚
            
            ### å®Ÿè¡Œæƒ…å ±
            - **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **å®Ÿè¡Œæ—¥æ™‚**: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}
            - **ãƒˆãƒªã‚¬ãƒ¼**: å®šæœŸå®Ÿè¡Œï¼ˆæ¯æ—¥åˆå‰9æ™‚ JSTï¼‰
            
            ### å¯¾å¿œãŒå¿…è¦ãªé …ç›®
            - [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ç¢ºèª
            - [ ] APIã®çŠ¶æ…‹ç¢ºèª
            - [ ] MCPè¨­å®šã®ç¢ºèª
            - [ ] Claude Code OAuth ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ç¢ºèª
            
            ### é–¢é€£ãƒªãƒ³ã‚¯
            - [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«](${{ github.server_url }}/${{ github.repository }}/blob/main/.github/workflows/auto-labeling.yml)
            - [å®Ÿè¡Œå±¥æ­´](${{ github.server_url }}/${{ github.repository }}/actions/workflows/auto-labeling.yml)
            
            cc: @${{ github.repository_owner }}
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'workflow', 'auto-labeling']
            });

      - name: Fallback Auto Labeling Script
        if: steps.final-status.outputs.final_outcome == 'failure'
        id: fallback-labeling
        run: |
          echo "::warning::Claude Code ActionãŒå¤±æ•—ã—ãŸãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™"
          cd ${{ github.workspace }}
          chmod +x .github/scripts/auto-label.js
          node .github/scripts/auto-label.js
        env:
          API_BASE_URL: "https://effective-yomimono-api.ryosuke-horie37.workers.dev"
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          MAX_ARTICLES: ${{ github.event.inputs.max_articles || '' }}
        continue-on-error: true

      - name: Final Validation
        if: steps.final-status.outputs.final_outcome == 'failure' && steps.fallback-labeling.outcome == 'failure'
        run: |
          echo "::error::è‡ªå‹•ãƒ©ãƒ™ãƒ«ä»˜ã‘ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚¸ãƒ§ãƒ–ã‚µãƒãƒªãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          exit 1