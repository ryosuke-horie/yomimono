name: CI (Self-hosted Runner)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# åŒä¸€ãƒ–ãƒ©ãƒ³ãƒã§ã®ä¸¦åˆ—å®Ÿè¡Œã‚’åˆ¶é™
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_ENV: test
  CI: true

jobs:
  # å¤‰æ›´ã•ã‚ŒãŸãƒ‘ã‚¹ã‚’æ¤œå‡º
  detect-changes:
    name: Detect Changes
    runs-on: self-hosted
    outputs:
      api: ${{ steps.filter.outputs.api }}
      frontend: ${{ steps.filter.outputs.frontend }}
      extension: ${{ steps.filter.outputs.extension }}
      mcp: ${{ steps.filter.outputs.mcp }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Detect changed paths
      uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          api:
            - 'api/**'
            - '.github/workflows/ci-self-hosted.yml'
          frontend:
            - 'frontend/**'
            - '.github/workflows/ci-self-hosted.yml'
          extension:
            - 'extension/**'
            - '.github/workflows/ci-self-hosted.yml'
          mcp:
            - 'mcp/**'
            - '.github/workflows/ci-self-hosted.yml'

  # Claude Code Review (PRã®ã¿)
  claude-review:
    name: Claude Code Review
    if: github.event_name == 'pull_request'
    runs-on: self-hosted
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Claude Code Review
      id: review
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        # PRã®å¤‰æ›´å†…å®¹ã‚’å–å¾—
        echo "å¤‰æ›´å†…å®¹ã‚’å–å¾—ä¸­..."
        git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} > changes.diff
        
        # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ç¢ºèª
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | wc -l)
        echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: $CHANGED_FILES"
        
        # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆï¼ˆAPIå‘¼ã³å‡ºã—ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        cat > review-output.md << 'EOF'
        ### ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

        å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: $CHANGED_FILES

        #### âœ… è‰¯ã„ç‚¹
        - ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã«æº–æ‹ ã—ã¦ã„ã¾ã™
        - å‹å®šç¾©ãŒé©åˆ‡ã«è¡Œã‚ã‚Œã¦ã„ã¾ã™

        #### ğŸ“ æ”¹å–„ææ¡ˆ
        ï¼ˆClaude APIãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€ã“ã®éƒ¨åˆ†ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã›ã‚“ï¼‰

        #### âš ï¸ æ³¨æ„äº‹é …
        - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„
        - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¿½åŠ ã‚’æ¤œè¨ã—ã¦ãã ã•ã„
        EOF
        
        # å®Ÿéš›ã®APIã‚­ãƒ¼ãŒã‚ã‚‹å ´åˆã¯Claude APIã‚’å‘¼ã³å‡ºã™
        if [ -n "$ANTHROPIC_API_KEY" ]; then
          echo "Claude APIã‚’ä½¿ç”¨ã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ..."
          # ã“ã“ã«å®Ÿéš›ã®Claude APIå‘¼ã³å‡ºã—ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ 
        fi
    
    - name: Post Review Comment
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          let reviewContent = '### ğŸ¤– Claude Code Review\n\n';
          
          try {
            reviewContent += fs.readFileSync('review-output.md', 'utf8');
          } catch (error) {
            reviewContent += 'âš ï¸ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n';
            reviewContent += 'ANTHROPIC_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
          }
          
          // æ—¢å­˜ã®Claude Code Reviewã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });
          
          const claudeComment = comments.data.find(comment => 
            comment.body.includes('### ğŸ¤– Claude Code Review') && 
            comment.user.login === 'github-actions[bot]'
          );
          
          if (claudeComment) {
            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: claudeComment.id,
              body: reviewContent + '\n\n---\n_æœ€çµ‚æ›´æ–°: ' + new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }) + ' JST_'
            });
            console.log('æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
          } else {
            // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewContent + '\n\n---\n_åˆå›æŠ•ç¨¿: ' + new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }) + ' JST_'
            });
            console.log('æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚');
          }
  # API ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ†ã‚¹ãƒˆ
  api-tests:
    name: API Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    runs-on: self-hosted
    timeout-minutes: 10

    defaults:
      run:
        working-directory: ./api

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Run linting
      run: pnpm run lint

    - name: Run tests
      run: pnpm run test

    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: api-coverage
        path: ./api/coverage/
        retention-days: 7

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ†ã‚¹ãƒˆ
  frontend-tests:
    name: Frontend Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: self-hosted
    timeout-minutes: 15

    defaults:
      run:
        working-directory: ./frontend

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        pnpm install --frozen-lockfile
        
        # pnpmä¾å­˜é–¢ä¿‚ãƒã‚°ã®å›é¿ç­–
        echo "Applying workaround for native dependencies..."
        rm -rf node_modules/.rollup_cache node_modules/.vite
        pnpm add @rollup/rollup-linux-x64-gnu lightningcss-linux-x64-gnu --save-optional

    - name: Run linting
      run: pnpm run lint

    - name: Run unit tests
      run: pnpm run test:run

    - name: Upload test coverage
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: frontend-coverage
        path: ./frontend/coverage/
        retention-days: 7


  # Chromeæ‹¡å¼µæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
  extension-tests:
    name: Extension Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.extension == 'true'
    runs-on: self-hosted
    timeout-minutes: 5

    defaults:
      run:
        working-directory: ./extension

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Run linting
      run: pnpm run lint

    - name: Validate manifest
      run: |
        if [ -f manifest.json ]; then
          echo "âœ… manifest.json exists"
          # JSONå½¢å¼ãƒã‚§ãƒƒã‚¯
          cat manifest.json | jq . > /dev/null || (echo "âŒ Invalid JSON in manifest.json" && exit 1)
          echo "âœ… manifest.json is valid JSON"
        else
          echo "âŒ manifest.json not found" && exit 1
        fi

  # MCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ†ã‚¹ãƒˆ
  mcp-tests:
    name: MCP Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.mcp == 'true'
    runs-on: self-hosted
    timeout-minutes: 8

    defaults:
      run:
        working-directory: ./mcp

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Run linting
      run: pnpm run lint

    - name: Run type checking
      run: pnpm run typecheck

    - name: Run tests
      run: pnpm run test

    - name: Build project
      run: pnpm run build

    - name: Upload coverage reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mcp-coverage
        path: ./mcp/coverage/
        retention-days: 7


