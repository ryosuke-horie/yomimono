name: Manual Labeling with Claude

on:
  issue_comment:
    types: [created]

jobs:
  manual-label:
    if: |
      github.event.issue.number == 770 && 
      contains(github.event.comment.body, '/label')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install and Build MCP
        run: |
          cd mcp
          pnpm install
          pnpm run build
          echo "MCPビルド完了"

      - name: Run Claude Manual Labeling
        id: claude-labeling
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          
          # MCPサーバー設定
          mcp_servers: |
            {
              "effective-yomimono-mcp": {
                "command": "node",
                "args": ["${{ github.workspace }}/mcp/build/index.js"],
                "env": {
                  "API_BASE_URL": "https://effective-yomimono-api.ryosuke-horie37.workers.dev"
                }
              }
            }
          
          # Direct prompt for manual labeling based on comment
          direct_prompt: |
            ユーザーのコメント: ${{ github.event.comment.body }}
            
            MCPツールを使用して記事のラベル付けを実行してください。
            
            コメントの内容に基づいて以下のいずれかの処理を行ってください：
            
            ## /label all - すべての未ラベル記事を自動ラベル付け
            1. getLabels で既存ラベル一覧を取得
            2. getUnlabeledArticles で未ラベル記事を取得
            3. 各記事のタイトルから適切なラベルを判定
            4. assignLabel または assignLabelsToMultipleArticles で割り当て
            
            ## /label check - 未ラベル記事の確認
            1. getUnlabeledArticles で未ラベル記事を取得
            2. 記事のタイトルとIDを一覧表示
            3. 推奨ラベルを提案（実際の割り当ては行わない）
            
            ## /label specific [article_id] [label_name] - 特定記事へのラベル付け
            1. 指定されたarticle_idにlabel_nameを割り当て
            2. ラベルが存在しない場合は新規作成
            
            処理結果を分かりやすく報告してください。