# 001_開発環境の仕様

このドキュメントでは、APIパッケージのローカル開発・テスト・シード手順を1か所に集約します。日常的な操作はここを参照し、`api/README.md` は本番デプロイ手順に専念させます。

## 1. 前提環境

- パッケージマネージャーは `pnpm` 固定（`only-allow` で強制）。
- APIは Cloudflare Workers（Wrangler）/Hono を使用。データベースは Cloudflare D1 を前提とし、ローカルでは Miniflare の D1 (`.wrangler/state/v3/d1`) を利用します。
- `.env` は `api/.env.example` を複製して作成します。フロントエンドは `frontend/.env.example` を `.env.local` として使用し、`NEXT_PUBLIC_API_BASE_URL=http://localhost:8787` を指定します。
- ネイティブ依存（better-sqlite3 や esbuild 等）は `pnpm.onlyBuiltDependencies` により `pnpm install` 時に自動ビルドされます。破損時は `pnpm rebuild` で再生成してください。

## 2. ローカルセットアップ手順

1. 依存インストール: `pnpm install`
2. D1ローカルDBの初期化: `pnpm run migrate:dev:local`
3. Seed投入（クリア→投入込み）: `pnpm run seed`
4. API起動: `pnpm run dev`（= `wrangler dev --local --env development`, ポート8787）
5. フロント起動: `cd frontend && pnpm run dev`（`.env.local` で API URL を 8787 に合わせる）

> Seed とローカル実行は同じ Miniflare D1 ファイルを共有します。初回またはマイグレーション後は必ず `pnpm run migrate:dev:local` を実行してください。

## 3. package.json スクリプト一覧

### 3.1 開発・ビルド

| コマンド | 説明 | 備考 |
| --- | --- | --- |
| `pnpm run dev` | `wrangler dev --env development --local` で Workers をローカル起動 | Port 8787/Miniflare |
| `pnpm run deploy` | `wrangler deploy --minify` で本番デプロイ | `NODE_ENV=production` |

### 3.2 テスト・品質

| コマンド | 説明 | 備考 |
| --- | --- | --- |
| `pnpm run lint` | Biome で静的解析 | 自動修正なし |
| `pnpm run format` | Biome のフォーマット適用 | 変更が発生する場合あり |
| `pnpm run test` | Vitest の単発実行 | `import.meta.vitest` ケース含む |
| `pnpm run knip` | 未使用コード検出 | 定期実行推奨 |

### 3.3 マイグレーション / DB ユーティリティ

| コマンド | 説明 | 備考 |
| --- | --- | --- |
| `pnpm run migrate:dev:local` | Wrangler D1 で `yomimono-db-dev` ローカルに適用 | Miniflare D1 のみを操作 |
| `pnpm run migrate:prod:remote` | Cloudflare リモート D1 へ適用 | `wrangler d1 migrations apply yomimono-db --remote` |
| `pnpm run db:generate` | Drizzle スキーマからマイグレーションを生成 | `drizzle-kit generate` |
| `pnpm run seed` | Miniflare D1 をクリア後、Seed データを投入 | `NODE_ENV=development` で実行 |

## 4. Seed 処理の構成

- ロジックは `src/scripts/seed.ts` に集約されており、`runSeedData` がブックマーク/ラベル/お気に入りをまとめて生成、`clearDatabase` が既存レコードを削除します。
- CLI エントリーポイント `src/scripts/seed-runner.ts` は `SEED_PRESET` に `clear` を指定した場合のみ削除を実行し、それ以外は常にデフォルト件数で投入します。
- Seed は常に `NODE_ENV=development` を強制し、本番 (`wrangler://yomimono-db`) には接続しません。Miniflare D1 ファイルを直接開くため、複数ファイルが存在する構成では `D1_SQLITE_PATH` で対象を指定できます。

## 5. Seed 実行手順

1. `pnpm run migrate:dev:local`
2. `pnpm run seed` （内部でクリア→投入）

## 6. 補足

- Seed のサンプル記事は技術記事を想定した URL/タイトルで構成されています。生成テーブルは `labels`, `bookmarks`, `article_labels`, `favorites` の4種です。
- `pnpm run test` は watch 無効の単発実行です。`pnpm run knip` は未使用コード検出の定期的なハウスキーピングとして活用してください。
