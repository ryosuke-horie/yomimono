# 001_開発環境の仕様

本書では、API/フロントエンドをローカルで独立起動する際の前提と、Seed処理の仕様・手順を整理します。

## 1. 前提環境

- パッケージマネージャーは `pnpm` 固定（`only-allow` で強制）。
- API は Cloudflare Workers（Wrangler）/Hono を利用し、データ永続化は以下で運用する。
- **Miniflare D1 (`.wrangler/state/v3/d1` 配下)**: `wrangler d1` が管理するローカルDB。Seed処理もこのファイルに直接書き込むため、初回は `pnpm run migrate:dev:local` でDBを作成しておく。APIサーバーは `pnpm run dev` (= `wrangler dev --local --env development`) でこのDBを参照する。
- `.env` は `api/.env.example` を複製して利用する。フロントは `frontend/.env.example` を `.env.local` として使用し、`NEXT_PUBLIC_API_BASE_URL=http://localhost:8787` を指定する。

## 2. Seed処理の構成

- 実体は `src/scripts/seed.ts` に集約されており、`runSeedData` がブックマーク/ラベル/お気に入りをまとめて生成し、`clearDatabase` が既存レコードを削除する。
- CLI エントリーポイントとして `src/scripts/seed-runner.ts` を追加済み。`SEED_PRESET` と任意の `SEED_OPTIONS`（JSON文字列）を受け取り、`runSeedData`/`clearDatabase` を安全に呼び出す。
- `pnpm run seed*` 系コマンドは常に `NODE_ENV=development` を強制しており、本番（`wrangler://yomimono-db`）へは接続できない。内部の `createDatabaseConnection()` でも `production` の場合は即時例外を投げるため、誤って本番DBにSeedが適用されることはない。

### 2.1 サポートコマンド

| コマンド | 内容 | 補足 |
| --- | --- | --- |
| `pnpm run seed` | デフォルト設定（25件/6ラベル/30%お気に入り）で Miniflare D1 に投入 | 既存データは毎回クリアされる |
| `pnpm run seed:test` | 軽量設定（5件/3ラベル/20%お気に入り）で投入 | `SEED_PRESET=test` |
| `pnpm run seed:clear` | Miniflare D1 のデータを全削除 | `SEED_PRESET=clear` |

プリセット外の件数で投入したい場合は、以下のように `SEED_OPTIONS` を JSON 文字列で渡す。

```bash
SEED_OPTIONS='{"bookmarkCount":50,"labelCount":8,"favoriteRatio":0.4}' pnpm run seed
```

## 3. Seed実行の推奨手順

ローカルのみで API/フロントを動かす場合は、以下の順に実施する。

1. **D1ローカルDBの初期化**: `pnpm run migrate:dev:local`
2. **データリセット（任意）**: `pnpm run seed:clear`
3. **Seed投入**: `pnpm run seed`（または `seed:test`）
4. **API起動**: `pnpm run dev`（内部で `wrangler dev --local --env development` を実行しポート8787で待ち受け）
5. **フロント起動**: `cd frontend && pnpm run dev`（`.env.local` で API ベースURLを 8787 に指定）

### 3.1 Wrangler D1 を利用する場合

Wrangler dev (`pnpm run dev`) は D1 (`yomimono-db-dev`) を参照するため、初回に必ず下記を実行してテーブルを作成する。

```bash
pnpm run migrate:dev:local
```

> Seedコマンドは `.wrangler/state/v3/d1` にある Miniflare D1 ファイルを直接操作します。複数のD1ファイルがある場合は `D1_SQLITE_PATH` で対象パスを指定できます。

## 4. よくあるエラーと対処

- `no such table: bookmarks` が出る場合：D1 ローカルにマイグレーションが適用されていない。`pnpm run migrate:dev:local` を実行してから API を再起動する。
- `シードデータ実行はサポートされていません`：`NODE_ENV=production` で Seed を実行しようとした。`NODE_ENV=development` でやり直す。
- `SEED_OPTIONS` の JSON パースエラー：`seed-runner` が JSON をそのまま `JSON.parse` している。ダブルクォートのエスケープ漏れ等を確認する。

## 5. 補足

- Seed のサンプル記事は `SAMPLE_TECH_ARTICLES`（25件）で、実際の技術カテゴリを想定したURL/タイトルが付与されている。
- 生成されるテーブルは `labels`, `bookmarks`, `article_labels`, `favorites` の4種。外部キー制約のため、削除・挿入ともに順序を固定している。
- Seed 処理は Vitest (`import.meta.vitest`) のテストブロックも内包しており、`pnpm run test` で挙動の回帰確認が可能。
